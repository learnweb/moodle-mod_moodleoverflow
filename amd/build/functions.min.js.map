{"version":3,"file":"functions.min.js","sources":["../src/functions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Ajax functions for moodleoverflow\n *\n * @module     mod_moodleoverflow/functions\n * @copyright  2017 Tamara Gunkel\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/config', 'core/url', 'core/str'],\n    function($, ajax, templates, notification, Cfg, Url, str) {\n\n    var RATING_SOLVED = 3;\n    var RATING_REMOVE_SOLVED = 30;\n    var RATING_HELPFUL = 4;\n    var RATING_REMOVE_HELPFUL = 40;\n\n    var t = {\n\n        /**\n         * Reoords a upvote / downvote.\n         * @param {int} discussionid\n         * @param {int} ratingid\n         * @param {int} userid\n         * @param {event} event\n         * @returns {string}\n         */\n        recordvote: function(discussionid, ratingid, userid, event) {\n            var target = $(event.target).closest('.moodleoverflowpost');\n            var postid = target.attr('id');\n            postid = postid.substring(1);\n\n            var vote = ajax.call([{\n                methodname: 'mod_moodleoverflow_record_vote',\n                args: {\n                    discussionid: discussionid,\n                    postid: postid,\n                    ratingid: ratingid,\n                    sesskey: Cfg.sesskey\n                }\n            }\n            ]);\n\n            vote[0].done(function(response) {\n\n                var parentdiv = $(event.target).parent().parent();\n                // Update Votes.\n                if (ratingid === 2) {\n                    parentdiv.children('a:first-of-type').children().attr(\n                        'src', Url.imageUrl('vote/upvoted', 'moodleoverflow'));\n                    parentdiv.children('a:nth-of-type(2)').children().attr(\n                        'src', Url.imageUrl('vote/downvote', 'moodleoverflow'));\n                } else if (ratingid === 1) {\n                    parentdiv.children('a:first-of-type').children().attr(\n                        'src', Url.imageUrl('vote/upvote', 'moodleoverflow'));\n                    parentdiv.children('a:nth-of-type(2)').children().attr(\n                        'src', Url.imageUrl('vote/downvoted', 'moodleoverflow'));\n                } else {\n                    parentdiv.children('a:first-of-type').children().attr(\n                        'src', Url.imageUrl('vote/upvote', 'moodleoverflow'));\n                    parentdiv.children('a:nth-of-type(2)').children().attr(\n                        'src', Url.imageUrl('vote/downvote', 'moodleoverflow'));\n                }\n\n                parentdiv.children('p').text(response.postrating);\n\n                // Update user reputation.\n                templates.replaceNode($('.user-details,.author').find('a[href*=\"id=' + userid + '\"]')\n                    .siblings('span'), '<span>' + response.raterreputation + '</span>', \"\");\n                if (response.ownerid && userid !== response.ownerid) {\n                    templates.replaceNode($('.user-details,.author').find('a[href*=\"id=' + response.ownerid + '\"]')\n                        .siblings('span'), '<span>' + response.ownerreputation + '</span>', \"\");\n                }\n            }).fail(notification.exception);\n\n            return vote;\n        },\n\n        /**\n         * Initializes the clickevent on upvotes / downvotes.\n         * @param {int} discussionid\n         * @param {int} userid\n         * @param {int} allowmultiplemarks\n         */\n        clickevent: function(discussionid, userid, allowmultiplemarks) {\n            allowmultiplemarks = 1;\n            if(allowmultiplemarks == 1) {}\n            $(\".upvote\").on(\"click\", function(event) {\n                if ($(event.target).is('a')) {\n                    event.target = $(event.target).children();\n                }\n\n                if ($(event.target).parent().attr('class').indexOf('active') >= 0) {\n                    t.recordvote(discussionid, 20, userid, event);\n                } else {\n                    t.recordvote(discussionid, 2, userid, event);\n                }\n                $(event.target).parent().toggleClass('active');\n                $(event.target).parent().nextAll('a').removeClass('active');\n            });\n\n            $(\".downvote\").on(\"click\", function(event) {\n                if ($(event.target).is('a')) {\n                    event.target = $(event.target).children();\n                }\n\n                if ($(event.target).parent().attr('class').indexOf('active') >= 0) {\n                    t.recordvote(discussionid, 10, userid, event);\n                } else {\n                    t.recordvote(discussionid, 1, userid, event);\n                }\n                $(event.target).parent().toggleClass('active');\n                $(event.target).parent().prevAll('a').removeClass('active');\n            });\n\n            $(\".marksolved\").on(\"click\", function(event) {\n                var post = $(event.target).parents('.moodleoverflowpost');\n\n                if (post.hasClass('statusteacher') || post.hasClass('statusboth')) {\n                    // Remove solution mark.\n                    t.recordvote(discussionid, RATING_REMOVE_SOLVED, userid, event)[0].then(function() {\n                        t.removeSolvedFromPost(post);\n                    });\n                } else {\n                    // Add solution mark.\n                    t.recordvote(discussionid, RATING_SOLVED, userid, event)[0].then(function() {\n                        /* check if allowmultiplemarks is on.\n                            if false: remove other solution marks (false means allowmultiplemarks == 0)\n                            else: do nothing. */\n                        if(discussionid == 0) {\n                            // Remove other solution mark in dom.\n                            t.removeOtherSolved(post.parent().parent());\n                            if (post.hasClass('statusstarter')) {\n                                post.removeClass('statusstarter');\n                                post.addClass('statusboth');\n                            } else {\n                                post.addClass('statusteacher');\n                            }\n\n                            var promiseStringNotSolved = str.get_string('marknotsolved', 'mod_moodleoverflow');\n                            $.when(promiseStringNotSolved).done(function(string) {\n                                $(event.target).text(string);\n                            });\n                            t.redoStatus(post);\n                        }\n                    });\n                }\n\n\n            });\n\n            $(\".markhelpful\").on(\"click\", function(event) {\n                var post = $(event.target).parents('.moodleoverflowpost');\n                if (post.hasClass('statusstarter') || post.hasClass('statusboth')) {\n                    // Remove helpful mark.\n                    t.recordvote(discussionid, RATING_REMOVE_HELPFUL, userid, event)[0].then(function() {\n                        t.removeHelpfulFromPost(post);\n                    });\n                } else {\n                    // Add helpful mark.\n                    t.recordvote(discussionid, RATING_HELPFUL, userid, event)[0].then(function() {\n                        /* check if allowmultiplemarks is on.\n                            if false: remove other helpful marks false means allowmultiplemarks == 0)\n                            else: do nothing. */\n                        if(discussionid == 0) {\n                            // Remove other helpful mark in dom.\n                            t.removeOtherHelpful(post.parent().parent());\n                            if (post.hasClass('statusteacher')) {\n                                post.removeClass('statusteacher');\n                                post.addClass('statusboth');\n                            } else {\n                                post.addClass('statusstarter');\n                            }\n\n                            var promiseStringNotHelpful = str.get_string('marknothelpful', 'mod_moodleoverflow');\n                            $.when(promiseStringNotHelpful).done(function(string) {\n                                $(event.target).text(string);\n                            });\n                            t.redoStatus(post);\n                        }\n                    });\n                }\n\n            });\n        },\n\n        removeHelpfulFromPost: function (post) {\n            if (post.hasClass('statusstarter')) {\n                post.removeClass('statusstarter');\n            } else {\n                post.removeClass('statusboth');\n                post.addClass('statusteacher');\n            }\n\n            t.redoStatus(post);\n\n            var promiseHelpful = str.get_string('markhelpful', 'mod_moodleoverflow');\n            $.when(promiseHelpful).done(function (string) {\n                post.find('.markhelpful').text(string);\n            });\n        },\n\n        removeOtherHelpful: function(root) {\n            var formerhelpful = root.find('.statusstarter, .statusboth');\n            if (formerhelpful.length > 0) {\n                t.removeHelpfulFromPost(formerhelpful);\n            }\n        },\n\n        removeSolvedFromPost: function(post) {\n            if (post.hasClass('statusteacher')) {\n                post.removeClass('statusteacher');\n            } else {\n                post.removeClass('statusboth');\n                post.addClass('statusstarter');\n            }\n\n            t.redoStatus(post);\n\n            var promiseHelpful = str.get_string('marksolved', 'mod_moodleoverflow');\n            $.when(promiseHelpful).done(function(string) {\n                post.find('.marksolved').text(string);\n            });\n        },\n\n        removeOtherSolved: function(root) {\n            var formersolution = root.find('.statusteacher, .statusboth');\n            if (formersolution.length > 0) {\n                t.removeSolvedFromPost(formersolution);\n            }\n        },\n\n        /**\n         * Redoes the post status\n         * @param {object} post dom with .moodleoverflowpost which status should be redone\n         */\n        redoStatus: function(post) {\n            if ($(post).hasClass('statusboth')) {\n                var statusBothRequest = [\n                    {key: 'teacherrating', component: 'mod_moodleoverflow'},\n                    {key: 'starterrating', component: 'mod_moodleoverflow'},\n                    {key: 'bestanswer', component: 'mod_moodleoverflow'}\n                ];\n                str.get_strings(statusBothRequest).then(function(results) {\n                    var circle = templates.renderPix('status/c_circle', 'mod_moodleoverflow', results[0]);\n                    var box = templates.renderPix('status/b_box', 'mod_moodleoverflow', results[1]);\n                    $.when(box, circle).done(function(boxImg, circleImg) {\n                        if (screen.width > 600) {\n                            post.find('.status').html(boxImg + circleImg + results[2]);\n                        } else {\n                            post.find('.status').html(boxImg + circleImg);\n                        }\n                    });\n                    return results;\n                });\n            } else if ($(post).hasClass('statusteacher')) {\n                var statusTeacherRequest = [\n                    {key: 'teacherrating', component: 'mod_moodleoverflow'},\n                    {key: 'solvedanswer', component: 'mod_moodleoverflow'}\n                ];\n                str.get_strings(statusTeacherRequest).then(function(results) {\n                    var circle = templates.renderPix('status/c_outline', 'mod_moodleoverflow', results[0]);\n                    $.when(circle).done(function(circleImg) {\n                        if (screen.width > 600) {\n                            post.find('.status').html(circleImg + results[1]);\n                        } else {\n                            post.find('.status').html(circleImg);\n                        }\n\n                    });\n                    return results;\n                });\n            } else if ($(post).hasClass('statusstarter')) {\n                var statusStarterRequest = [\n                    {key: 'starterrating', component: 'mod_moodleoverflow'},\n                    {key: 'helpfulanswer', component: 'mod_moodleoverflow'}\n                ];\n                str.get_strings(statusStarterRequest).then(function(results) {\n                    var box = templates.renderPix('status/b_outline', 'mod_moodleoverflow', results[0]);\n                    $.when(box).done(function(boxImg) {\n                        if (screen.width > 600) {\n                            post.find('.status').html(boxImg + results[1]);\n                        } else {\n                            post.find('.status').html(boxImg);\n                        }\n                    });\n                    return results;\n                });\n            } else {\n                post.find('.status').html('');\n            }\n\n        }\n    };\n\n    return t;\n});\n"],"names":["define","$","ajax","templates","notification","Cfg","Url","str","t","recordvote","discussionid","ratingid","userid","event","postid","target","closest","attr","substring","vote","call","methodname","args","sesskey","done","response","parentdiv","parent","children","imageUrl","text","postrating","replaceNode","find","siblings","raterreputation","ownerid","ownerreputation","fail","exception","clickevent","allowmultiplemarks","on","is","indexOf","toggleClass","nextAll","removeClass","prevAll","post","parents","hasClass","then","removeSolvedFromPost","removeOtherSolved","addClass","promiseStringNotSolved","get_string","when","string","redoStatus","removeHelpfulFromPost","removeOtherHelpful","promiseStringNotHelpful","promiseHelpful","root","formerhelpful","length","formersolution","get_strings","key","component","results","circle","renderPix","box","boxImg","circleImg","screen","width","html"],"mappings":"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"}