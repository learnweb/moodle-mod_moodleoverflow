define("mod_moodleoverflow/rating",["exports","core/ajax","core/prefetch","core/str"],(function(_exports,_ajax,_prefetch,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=function(userid,allowmultiplemarks){_prefetch.default.prefetchStrings("mod_moodleoverflow",["marksolved","marknotsolved","markhelpful","marknothelpful","action_remove_upvote","action_upvote","action_remove_downvote","action_downvote"]),root.onclick=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(event){var actionElement,action,postElement,postid,isupvote,otherAction,otherElement,isHelpful,htmlclass,shouldRemove,baseRating,rating,_iterator,_step,el;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(actionElement=event.target.closest("[data-moodleoverflow-action]")){_context.next=3;break}return _context.abrupt("return");case 3:action=actionElement.getAttribute("data-moodleoverflow-action"),postElement=actionElement.closest("[data-moodleoverflow-postid]"),postid=null==postElement?void 0:postElement.getAttribute("data-moodleoverflow-postid"),_context.t0=action,_context.next="upvote"===_context.t0||"downvote"===_context.t0?9:"helpful"===_context.t0||"solved"===_context.t0?32:73;break;case 9:if(isupvote="upvote"===action,"clicked"!==actionElement.getAttribute("data-moodleoverflow-state")){_context.next=19;break}return _context.next=13,sendVote(postid,isupvote?RATING_REMOVE_UPVOTE:RATING_REMOVE_DOWNVOTE,userid);case 13:return actionElement.setAttribute("data-moodleoverflow-state","notclicked"),_context.next=16,(0,_str.get_string)("action_"+action,"mod_moodleoverflow");case 16:actionElement.title=_context.sent,_context.next=31;break;case 19:return otherAction=isupvote?"downvote":"upvote",_context.next=22,sendVote(postid,isupvote?RATING_UPVOTE:RATING_DOWNVOTE,userid);case 22:return actionElement.setAttribute("data-moodleoverflow-state","clicked"),(otherElement=postElement.querySelector('[data-moodleoverflow-action="'.concat(otherAction,'"]'))).setAttribute("data-moodleoverflow-state","notclicked"),_context.next=27,(0,_str.get_string)("action_remove_"+action,"mod_moodleoverflow");case 27:return actionElement.title=_context.sent,_context.next=30,(0,_str.get_string)("action_"+otherAction,"mod_moodleoverflow");case 30:otherElement.title=_context.sent;case 31:return _context.abrupt("break",73);case 32:return htmlclass=(isHelpful="helpful"===action)?"markedhelpful":"markedsolution",shouldRemove=postElement.classList.contains(htmlclass),baseRating=isHelpful?RATING_HELPFUL:RATING_SOLVED,rating=shouldRemove?10*baseRating:baseRating,_context.next=39,sendVote(postid,rating,userid);case 39:if(allowmultiplemarks){_context.next=61;break}_iterator=_createForOfIteratorHelper(root.querySelectorAll(".moodleoverflowpost."+htmlclass)),_context.prev=41,_iterator.s();case 43:if((_step=_iterator.n()).done){_context.next=51;break}return(el=_step.value).classList.remove(htmlclass),_context.next=48,(0,_str.get_string)("mark".concat(action),"mod_moodleoverflow");case 48:el.querySelector('[data-moodleoverflow-action="'.concat(action,'"]')).textContent=_context.sent;case 49:_context.next=43;break;case 51:_context.next=56;break;case 53:_context.prev=53,_context.t1=_context.catch(41),_iterator.e(_context.t1);case 56:return _context.prev=56,_iterator.f(),_context.finish(56);case 59:_context.next=67;break;case 61:if(!shouldRemove){_context.next=67;break}return postElement.classList.remove(htmlclass),_context.next=65,(0,_str.get_string)("mark".concat(action),"mod_moodleoverflow");case 65:actionElement.textContent=_context.sent,changeStrings(htmlclass,action);case 67:if(shouldRemove){_context.next=73;break}return postElement.classList.add(htmlclass),_context.next=71,(0,_str.get_string)("marknot".concat(action),"mod_moodleoverflow");case 71:actionElement.textContent=_context.sent,allowmultiplemarks&&changeStrings(htmlclass,action);case 73:case"end":return _context.stop()}}),_callee,null,[[41,53,56,59]])}))),function(_x4){return _ref.apply(this,arguments)});var _ref},_ajax=_interopRequireDefault(_ajax),_prefetch=_interopRequireDefault(_prefetch);var RATING_DOWNVOTE=1,RATING_UPVOTE=2,RATING_REMOVE_DOWNVOTE=10,RATING_REMOVE_UPVOTE=20,RATING_SOLVED=3,RATING_HELPFUL=4,root=document.getElementById("moodleoverflow-root");function sendVote(_x,_x2,_x3){return _sendVote.apply(this,arguments)}function _sendVote(){return(_sendVote=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(postid,rating,userid){var response;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,_ajax.default.call([{methodname:"mod_moodleoverflow_record_vote",args:{postid:postid,ratingid:rating}}])[0];case 2:return response=_context2.sent,root.querySelectorAll('[data-moodleoverflow-userreputation="'.concat(userid,'"]')).forEach((function(i){i.textContent=response.raterreputation})),root.querySelectorAll('[data-moodleoverflow-userreputation="'.concat(response.ownerid,'"]')).forEach((function(i){i.textContent=response.ownerreputation})),root.querySelectorAll('[data-moodleoverflow-postreputation="'.concat(postid,'"]')).forEach((function(i){i.textContent=response.postrating})),_context2.abrupt("return",response);case 7:case"end":return _context2.stop()}}),_callee2)})))).apply(this,arguments)}function changeStrings(_x5,_x6){return _changeStrings.apply(this,arguments)}function _changeStrings(){return(_changeStrings=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(htmlclass,action){var othermarkedposts,_iterator2,_step2,_iterator3,_step3,_el;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:_prefetch.default.prefetchStrings("mod_moodleoverflow",["marksolved","alsomarksolved","markhelpful","alsomarkhelpful"]),othermarkedposts=!1,_iterator2=_createForOfIteratorHelper(root.querySelectorAll(".moodleoverflowpost")),_context3.prev=3,_iterator2.s();case 5:if((_step2=_iterator2.n()).done){_context3.next=12;break}if(!_step2.value.classList.contains(htmlclass)){_context3.next=10;break}return othermarkedposts=!0,_context3.abrupt("break",12);case 10:_context3.next=5;break;case 12:_context3.next=17;break;case 14:_context3.prev=14,_context3.t0=_context3.catch(3),_iterator2.e(_context3.t0);case 17:return _context3.prev=17,_iterator2.f(),_context3.finish(17);case 20:_iterator3=_createForOfIteratorHelper(root.querySelectorAll(".moodleoverflowpost")),_context3.prev=21,_iterator3.s();case 23:if((_step3=_iterator3.n()).done){_context3.next=37;break}if((_el=_step3.value).classList.contains(htmlclass)||!_el.querySelector('[data-moodleoverflow-action="'.concat(action,'"]'))){_context3.next=35;break}if(!othermarkedposts){_context3.next=32;break}return _context3.next=29,(0,_str.get_string)("alsomark".concat(action),"mod_moodleoverflow");case 29:_el.querySelector('[data-moodleoverflow-action="'.concat(action,'"]')).textContent=_context3.sent,_context3.next=35;break;case 32:return _context3.next=34,(0,_str.get_string)("mark".concat(action),"mod_moodleoverflow");case 34:_el.querySelector('[data-moodleoverflow-action="'.concat(action,'"]')).textContent=_context3.sent;case 35:_context3.next=23;break;case 37:_context3.next=42;break;case 39:_context3.prev=39,_context3.t1=_context3.catch(21),_iterator3.e(_context3.t1);case 42:return _context3.prev=42,_iterator3.f(),_context3.finish(42);case 45:case"end":return _context3.stop()}}),_callee3,null,[[3,14,17,20],[21,39,42,45]])})))).apply(this,arguments)}}));

//# sourceMappingURL=rating.min.js.map